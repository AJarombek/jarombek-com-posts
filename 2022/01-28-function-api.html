<div>
<Note type="info">
This is part of a series of articles on SaintsXCTF Version 2.0. The first article in the series provides an
<a href="https://jarombek.com/blog/jun-14-2021-saints-xctf-v2-overview">overview of the application</a>.  You
<strong>DO NOT</strong> need to read prior articles in the series to fully understand this article.
</Note>
<p>
My <a href="https://saintsxctf.com/">SaintsXCTF</a> application has multiple APIs.  One of these APIs,
<strong>fn.saintsxctf.com</strong>, is hosted on AWS API Gateway and AWS Lambda.  Its main purpose is to send emails to
users based on certain website actions, such as changing a password or signing up.  In this article, I discuss the
infrastructure needed to make the API, the source code of the API endpoints, and the approach used to deploy the API
to AWS.
</p>
<SubTitle title="SaintsXCTF Version 2.0 Articles">SaintsXCTF Version 2.0 Articles</SubTitle>
<ul>
<li><a href="https://jarombek.com/blog/jun-14-2021-saints-xctf-v2-overview">Architectural Overview</a></li>
<li><a href="https://jarombek.com/blog/jun-14-2021-saints-xctf-v2-overview">AWS Infrastructure</a></li>
<li><a href="https://jarombek.com/blog/oct-25-2021-saints-xctf-v2-k8s-infrastructure">Kubernetes Infrastructure</a></li>
<li><a href="https://jarombek.com/blog/nov-1-2021-saints-xctf-v2-react-web-app">React Web Application Overview</a></li>
<li><a href="https://jarombek.com/blog/nov-15-2021-react-typescript">Web Application React and TypeScript</a></li>
<li><a href="https://jarombek.com/blog/dec-3-2021-redux-react">Web Application Redux State Configuration</a></li>
<li><a href="https://jarombek.com/blog/aug-11-2021-cypress-typescript">Web Application Cypress E2E Tests</a></li>
<li><a href="https://jarombek.com/blog/jun-30-2021-react-jss">Web Application JSS Modular Design</a></li>
<li><a href="https://jarombek.com/blog/dec-24-2021-flask-python-api">Flask Python API</a></li>
<li><a href="https://jarombek.com/blog/jan-10-2022-flask-api-testing">Flask API Testing</a></li>
<li><strong>Function API Using API Gateway & Lambda</strong></li>
<li>Auth API Using API Gateway & Lambda</li>
<li>Database Deployments Using Jenkins</li>
<li>Database Client on Kubernetes</li>
<li>Testing and Continuous Deployment on Jenkins</li>
</ul>
<SectionTitle title="API Infrastructure">API Infrastructure</SectionTitle>
<p>
The Infrastructure for my email sending API is written using Terraform and exists in my <a href="https://github.com/
AJarombek/saints-xctf-infrastructure/tree/master/saints-xctf-com-fn">saints-xctf-infrastructure</a> repository.  The
Terraform configuration contains three modules, two of which I’ll discuss in this article: <a href="https://github.com/
AJarombek/saints-xctf-infrastructure/tree/master/saints-xctf-com-fn/modules/api-gateway">api-gateway</a> and
<a href="https://github.com/AJarombek/saints-xctf-infrastructure/tree/master/saints-xctf-com-fn/modules/email-lambda">
email-lambda</a>.  <strong>api-gateway</strong> contains API Gateway infrastructure, and <strong>email-lambda</strong>
contains AWS Lambda infrastructure.
</p>
<p>
The following infrastructure diagram represents the <strong>fn.saintsxctf.com</strong> API, with the two Terraform
modules outlined.
</p>
<InlineImage filename="1-28-22-api-infrastructure.png" paddingTop="true" paddingBottom="true">
</InlineImage>
<p>
This infrastructure creates a REST API that clients can access over HTTPS.  Clients make HTTP requests, for example, a
POST request to the <strong>https://fn.saintsxctf.com/email/welcome</strong> endpoint.  API Gateway handles these HTTP
requests to endpoints and triggers corresponding AWS Lambda functions.  Once the AWS Lambda function completes, its
result is returned back to API Gateway and sent to the client in the HTTP response body.
</p>
<p>
Infrastructure for AWS API Gateway is centered around a <a href="https://github.com/AJarombek/
saints-xctf-infrastructure/blob/master/saints-xctf-com-fn/modules/api-gateway/main.tf">main.tf</a> file within the
<a href="https://github.com/AJarombek/saints-xctf-infrastructure/tree/master/saints-xctf-com-fn/modules/api-gateway">
api-gateway</a> Terraform module.  Infrastructure for AWS Lambda is centered around a <a href="https://github.com/
AJarombek/saints-xctf-infrastructure/blob/master/saints-xctf-com-fn/modules/email-lambda/main.tf">main.tf</a> file
within the <a href="https://github.com/AJarombek/saints-xctf-infrastructure/tree/master/saints-xctf-com-fn/modules/
email-lambda">email-lambda</a> Terraform module.  I won’t discuss infrastructure specifics, but if you want to learn
more about writing Terraform for API Gateway and Lambda I’ve written <a href="https://jarombek.com/blog/
sep-7-2018-aws-lambda-api-gateway">an article</a> about it in the past.
</p>
<SectionTitle title="Endpoint Application Code">Endpoint Application Code</SectionTitle>
<p>
The API endpoints are configured as AWS Lambda functions written in JavaScript.  All the Lambda functions exist in a
<a href="https://github.com/AJarombek/saints-xctf-functions">saints-xctf-functions</a> repository on GitHub.
</p>
<p>
Since most of the endpoints in this API are similar, let’s look at a single endpoint, <strong>
https://fn.saintsxctf.com/email/welcome</strong>, in detail.  This endpoint sends a welcome email to new users when they
initially sign up.  An example of a welcome email is displayed below.
</p>
<InlineImage filename="1-28-22-welcome-email.png" paddingTop="true" paddingBottom="true">
</InlineImage>
<p>
The Lambda function code for the welcome email endpoint exists in an npm module.  The module has two entrypoint files:
<a href="https://github.com/AJarombek/saints-xctf-functions/blob/main/welcome/sendEmailAWS.js">sendEmailAWS.js</a> and
<a href="https://github.com/AJarombek/saints-xctf-functions/blob/main/welcome/sendEmailNode.js">sendEmailNode.js</a>.
<strong>sendEmailAWS.js</strong> is used for sending emails from AWS Lambda and <strong>sendEmailNode.js</strong> is
used for sending emails locally.
</p>
<CodeSnippet language="JavaScript">
// sendEmailAWS.js

const AWS = require('aws-sdk');
const sendWelcomeEmail = require('./email');

AWS.config.update({region: 'us-east-1'});

/**
 * Invoke an AWS function via the handler object
 * @param event - information about the AWS Lambda function request
 * @param context - runtime information regarding the AWS lambda function
 * @param callback - used to return information back to the caller.
 */
exports.sendWelcomeEmail = (event, context, callback) => {
    try {
        sendWelcomeEmail(event.to, event.firstName, event.lastName, event.username);
        callback(null, true);
    } catch (err) {
        console.error(err);
        callback(Error(err), false);
    }
};
</CodeSnippet>
<CodeSnippet language="JavaScript">
// sendEmailNode.js

const sendWelcomeEmail = require('./email');

const [_, __, to, firstName, lastName, username] = process.argv;

sendWelcomeEmail(to, firstName, lastName, username);
</CodeSnippet>
<p>
<strong>sendEmailNode.js</strong> is great for testing because sending an email is as simple as running the following
command from the command line.
</p>
<CodeSnippet language="Bash">
node sendEmailNode andrew@jarombek.com Andrew Jarombek andy
</CodeSnippet>
<SectionTitle title="Deployment Approach">Deployment Approach</SectionTitle>
<SectionTitle title="Conclusions">Conclusions</SectionTitle>
</div>